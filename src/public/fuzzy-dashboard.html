<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Matching & Context Rewrite Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .performance-score {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .score-excellent { background: #dcfce7; color: #166534; }
        .score-good { background: #fef3c7; color: #92400e; }
        .score-poor { background: #fee2e2; color: #991b1b; }
        .refresh-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover {
            background: #1d4ed8;
        }
        .loading {
            opacity: 0.6;
        }
        .error {
            color: #dc2626;
            background: #fee2e2;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fuzzy Matching & Context Rewrite Dashboard</h1>
            <p>Real-time monitoring of maintenance detection, units normalization, and context rewrite operations</p>
            <button class="refresh-btn" onclick="refreshMetrics()">Refresh Metrics</button>
        </div>

        <div id="error-container"></div>

        <div class="metrics-grid">
            <!-- Maintenance Detection -->
            <div class="metric-card">
                <div class="metric-title">Maintenance Detection</div>
                <div class="metric-value" id="maintenance-operations">-</div>
                <div class="metric-label">Total Operations</div>
                
                <div class="metric-value" id="maintenance-success-rate">-</div>
                <div class="metric-label">Success Rate</div>
                
                <div class="metric-value" id="maintenance-duration">-</div>
                <div class="metric-label">Avg Duration (ms)</div>
                
                <div class="metric-value" id="maintenance-performance">-</div>
                <div class="metric-label">Performance Score</div>
            </div>

            <!-- Units Normalization -->
            <div class="metric-card">
                <div class="metric-title">Units Normalization</div>
                <div class="metric-value" id="units-operations">-</div>
                <div class="metric-label">Total Operations</div>
                
                <div class="metric-value" id="units-success-rate">-</div>
                <div class="metric-label">Success Rate</div>
                
                <div class="metric-value" id="units-duration">-</div>
                <div class="metric-label">Avg Duration (ms)</div>
                
                <div class="metric-value" id="units-performance">-</div>
                <div class="metric-label">Performance Score</div>
                
                <div class="metric-value" id="units-fuzzy-rate">-</div>
                <div class="metric-label">Fuzzy Success Rate</div>
            </div>

            <!-- Context Rewrite -->
            <div class="metric-card">
                <div class="metric-title">Context Rewrite</div>
                <div class="metric-value" id="context-operations">-</div>
                <div class="metric-label">Total Operations</div>
                
                <div class="metric-value" id="context-success-rate">-</div>
                <div class="metric-label">Success Rate</div>
                
                <div class="metric-value" id="context-duration">-</div>
                <div class="metric-label">Avg Duration (ms)</div>
                
                <div class="metric-value" id="context-performance">-</div>
                <div class="metric-label">Performance Score</div>
            </div>

            <!-- Overall Fuzzy Matching -->
            <div class="metric-card">
                <div class="metric-title">Overall Fuzzy Matching</div>
                <div class="metric-value" id="fuzzy-operations">-</div>
                <div class="metric-label">Total Operations</div>
                
                <div class="metric-value" id="fuzzy-success-rate">-</div>
                <div class="metric-label">Success Rate</div>
                
                <div class="metric-value" id="fuzzy-performance">-</div>
                <div class="metric-label">Performance Score</div>
                
                <div class="metric-value" id="fuzzy-corrections">-</div>
                <div class="metric-label">Typo Corrections</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-title">System Status</div>
            <div id="system-status">Loading...</div>
        </div>
    </div>

    <script>
        let refreshInterval;

        function getPerformanceClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            return 'score-poor';
        }

        function formatPercentage(value) {
            return `${(value * 100).toFixed(1)}%`;
        }

        function formatDuration(value) {
            return `${value.toFixed(2)}ms`;
        }

        function updateMetrics(data) {
            // Maintenance Detection
            document.getElementById('maintenance-operations').textContent = data.summary.maintenanceDetection.totalOperations || 0;
            document.getElementById('maintenance-success-rate').textContent = formatPercentage(data.summary.maintenanceDetection.successRate || 0);
            document.getElementById('maintenance-duration').textContent = formatDuration(data.summary.maintenanceDetection.avgDuration || 0);
            
            const maintenanceScore = data.summary.maintenanceDetection.performanceScore || 0;
            const maintenanceScoreEl = document.getElementById('maintenance-performance');
            maintenanceScoreEl.textContent = `${maintenanceScore}/100`;
            maintenanceScoreEl.className = `performance-score ${getPerformanceClass(maintenanceScore)}`;

            // Units Normalization
            document.getElementById('units-operations').textContent = data.summary.unitsNormalization.totalOperations || 0;
            document.getElementById('units-success-rate').textContent = formatPercentage(data.summary.unitsNormalization.successRate || 0);
            document.getElementById('units-duration').textContent = formatDuration(data.summary.unitsNormalization.avgDuration || 0);
            
            const unitsScore = data.summary.unitsNormalization.performanceScore || 0;
            const unitsScoreEl = document.getElementById('units-performance');
            unitsScoreEl.textContent = `${unitsScore}/100`;
            unitsScoreEl.className = `performance-score ${getPerformanceClass(unitsScore)}`;
            
            document.getElementById('units-fuzzy-rate').textContent = formatPercentage(data.summary.unitsNormalization.fuzzySuccessRate || 0);

            // Context Rewrite
            document.getElementById('context-operations').textContent = data.summary.contextRewrite.totalOperations || 0;
            document.getElementById('context-success-rate').textContent = formatPercentage(data.summary.contextRewrite.successRate || 0);
            document.getElementById('context-duration').textContent = formatDuration(data.summary.contextRewrite.avgDuration || 0);
            
            const contextScore = data.summary.contextRewrite.performanceScore || 0;
            const contextScoreEl = document.getElementById('context-performance');
            contextScoreEl.textContent = `${contextScore}/100`;
            contextScoreEl.className = `performance-score ${getPerformanceClass(contextScore)}`;

            // Overall Fuzzy Matching
            document.getElementById('fuzzy-operations').textContent = data.summary.overall.totalOperations || 0;
            document.getElementById('fuzzy-success-rate').textContent = formatPercentage(data.summary.overall.successRate || 0);
            
            const fuzzyScore = data.summary.overall.performanceScore || 0;
            const fuzzyScoreEl = document.getElementById('fuzzy-performance');
            fuzzyScoreEl.textContent = `${fuzzyScore}/100`;
            fuzzyScoreEl.className = `performance-score ${getPerformanceClass(fuzzyScore)}`;
            
            document.getElementById('fuzzy-corrections').textContent = data.summary.overall.typoCorrections || 0;

            // System Status
            const statusEl = document.getElementById('system-status');
            const totalOps = (data.summary.maintenanceDetection.totalOperations || 0) + 
                           (data.summary.unitsNormalization.totalOperations || 0) + 
                           (data.summary.contextRewrite.totalOperations || 0);
            
            statusEl.innerHTML = `
                <div><strong>Total Operations:</strong> ${totalOps}</div>
                <div><strong>Last Updated:</strong> ${new Date(data.raw.lastUpdated).toLocaleString()}</div>
                <div><strong>Metric Categories:</strong> ${data.raw.metricCategories.join(', ')}</div>
            `;
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">Error: ${message}</div>`;
        }

        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        async function fetchMetrics() {
            try {
                clearError();
                document.body.classList.add('loading');
                
                const response = await fetch('/admin/metrics/fuzzy', {
                    headers: {
                        'x-admin-token': 'your-admin-token-here' // Replace with actual admin token
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateMetrics(result.data);
                } else {
                    throw new Error(result.error?.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
                showError(error.message);
            } finally {
                document.body.classList.remove('loading');
            }
        }

        function refreshMetrics() {
            fetchMetrics();
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(fetchMetrics, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchMetrics();
            startAutoRefresh();
        });

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
