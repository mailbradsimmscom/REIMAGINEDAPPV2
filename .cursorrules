Style & runtime

Node 20. ESM only. No console.log (use src/utils/logger.js).

Read env only via src/config/env.js.

Architecture

Flow: routes → services → repositories.

Routes: thin, no I/O or business logic.

Services: business logic only.

Repositories: all DB/storage/network I/O.

Forbidden: route → repository imports.

HTTP contract

Every response: { success, data?, error?, requestId? } unchanged.

Zod: validate input at the route edge; response gated by RESPONSE_VALIDATE=1 (CI on, prod off until proven).

Security & limits

/admin/* is behind adminOnly (x-admin-token).

JSON body ≤ 2 MB (except explicit upload routes).

CORS allow-list only. Security headers on.

Files

Max 250 lines per file (soft for tests/migrations).

No *.routes.js (legacy). Use *.router.js (barrels) and *.route.js (leaf endpoints).

No artifacts in repo: node_modules/, logs, dumps, PDFs, venvs, builds.

Changes

Any schema/data change ships with: SQL migration + Zod + tests + docs (same PR).

Breaking API or sidecar contract: propose first, then code.